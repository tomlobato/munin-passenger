#!/usr/bin/env ruby

# Install

# 1)
# wget https://raw.githubusercontent.com/tomlobato/munin-passenger5/master/passenger
# chmod 755 passenger
# mv passenger /etc/munin/plugins/passenger

# 2)
# Add this to /etc/munin/plugin-conf.d/munin-node :
# [passenger]
# user root
# env.PASSENGER_INSTANCE_REGISTRY_DIR /tmp/aptmp

# 3)
# /etc/init.d/munin-node restart

class SimplePassengerStatus
    def cli argv
        if argv[0] == 'config'
            config
        else
            run
        end
    end

    def config
        puts <<-CONFIG
graph_category Passenger
graph_title Passenger stats
graph_vlabel count
graph_args --base 1000 -l 0
graph_info Passenger stats

max_pool_size.label max pool size
app_groups.label app groups
processes.label processes
requests_in_top_level_queue.label requests in top level queue 
requests_in_queue.label requests in queue
sessions.label sessions
processed.label processed /10000
cpu.label %cpu /10
memory.label memory /100
CONFIG

        exit 0
    end

    def str_list str
        str
            .split(/\n/)
            .map(&:strip)
            .reject(&:empty?)
    end

    def run
        status = `passenger-status --no-header`

        str_list("
            Max pool size
            App groups
            Processes
            Requests in top-level queue        
            Requests in queue
            Sessions
            Processed /10000
            CPU /10
            Memory /100
        ").each do |str|
            divisor = 1
            if str =~ /^(.*?)\s*\/\s*(\d+)\s*$/
                str = $1
                divisor = $2.to_f
            end
            key = str.downcase.gsub(/(\s|-)+/, '_')

            total = 0
            status.scan(/#{str}\s*:\s*(\d+)/).flatten.each { |count| 
                total += count.to_i 
            }

            puts "#{key}.value #{total/divisor}"
        end
        
        exit 0
    end
end

SimplePassengerStatus.new.cli ARGV
